name: "Flake.lock: update Nix dependencies"

on:
  workflow_dispatch: # allows manual triggering
  schedule:
    - cron: '0 17 * * FRI'  # At 17:00 on Friday (UTC)

jobs:
  nix-flake-update:
    permissions:
      contents: write
      id-token: write
      issues: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: DeterminateSystems/determinate-nix-action@v3
      - id: update
        uses: DeterminateSystems/update-flake-lock@main
        with:
          pr-title: "Update Nix flake inputs" # Title of PR to be created
          pr-labels: | # Labels to be set on the PR
            dependencies
            automated
      - name: Check Nixpkgs
        uses: DeterminateSystems/flake-checker-action@main
        with:
          fail-mode: true
      - name: Comment on PR if check failed
        if: failure()
        uses: actions/github-script@v6
        env:
          PR_NUMBER: ${{ steps.update.outputs.pull-request-number }}
        with:
          script: |
            // Use the `context` helper provided by actions/github-script
            const { owner, repo } = context.repo;
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            // Prefer the PR number from the update action if available
            let prNumber = process.env.PR_NUMBER ? Number(process.env.PR_NUMBER) : null;

            // If still no PR, try to get PR number from the workflow event
            if (!prNumber && context.payload && context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            }

            // If no PR yet, try to find an open PR whose head matches the ref
            if (!prNumber) {
              const headRef = context.ref.replace('refs/heads/', '');
              const prs = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open'
              });
              const matched = prs.data.find(p => p.head && p.head.ref === headRef);
              if (matched) prNumber = matched.number;
            }

            const body = `flake-checker detected failures. See the Actions run for details: ${runUrl}`;
            if (prNumber) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body,
              });
            } else {
              // Fallback: open an issue so maintainers get notified
              await github.rest.issues.create({
                owner,
                repo,
                title: 'flake-checker: failure when updating flake inputs',
                body: `The scheduled/automated flake update run failed. ${body}`,
              });
            }