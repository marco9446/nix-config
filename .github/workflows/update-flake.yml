name: "Flake.lock: update Nix dependencies"

on:
  workflow_dispatch: # allows manual triggering
  schedule:
    - cron: '0 17 * * FRI'  # At 17:00 on Friday (UTC)

jobs:
  nix-flake-update:
    permissions:
      contents: write
      issues: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/update-flake-lock@main
        id: update
        with:
          pr-title: "Update Nix flake inputs" # Title of PR to be created
          pr-labels: | # Labels to be set on the PR
            dependencies
            automated
      - name: Check Nixpkgs
        uses: DeterminateSystems/flake-checker-action@main
        with:
          fail-mode: true
      - name: Comment on PR if check failed
        if: failure()
        uses: actions/github-script@v6
        env:
          PR_NUMBER: ${{ steps.update.outputs.pull-request-number }}
        with:
          script: |
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${github.context.repo.owner}/${github.context.repo.repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            // Prefer the PR number from the update action if available
            let prNumber = process.env.PR_NUMBER ? Number(process.env.PR_NUMBER) : null;

            // If still no PR, try to get PR number from the workflow event
            if (!prNumber && github.context.payload.pull_request) {
              prNumber = github.context.payload.pull_request.number;
            }

            const body = `flake-checker detected failures. See the Actions run for details: ${runUrl}`;

            if (prNumber) {
              await github.rest.issues.createComment({
                owner: github.context.repo.owner,
                repo: github.context.repo.repo,
                issue_number: prNumber,
                body,
              });
            } else {
              // Fallback: open an issue so maintainers get notified
              await github.rest.issues.create({
                owner: github.context.repo.owner,
                repo: github.context.repo.repo,
                title: 'flake-checker: failure when updating flake inputs',
                body: `The scheduled/automated flake update run failed. ${body}`,
              });
            }